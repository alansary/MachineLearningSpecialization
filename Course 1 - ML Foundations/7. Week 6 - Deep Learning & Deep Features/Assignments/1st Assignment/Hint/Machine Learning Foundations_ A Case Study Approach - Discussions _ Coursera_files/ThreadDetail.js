define("bundles/discussions/components/discussionsBody/ThreadDetail",["require","exports","module","jsuri","react-router","react","underscore","bundles/discussions/actions/ThreadDetailsActions","bundles/discussions/components/discussionsBody/DetailedQuestion","bundles/discussions/components/SessionDetails","bundles/discussions/components/SoftDelete","bundles/discussions/components/profiles/ProfileArea","bundles/discussions/components/repliesList/HighlightedReply","bundles/discussions/components/repliesList/RepliesList","bundles/discussions/components/repliesList/ReplyCMLInput","bundles/discussions/components/NextViewLink","bundles/discussions/components/ModerationDropdown","bundles/discussions/components/threadSettings/ThreadSettings","bundles/discussions/constants","bundles/discussions/utils/discussionsUrl","bundles/discussions/api/threadDetailsUtils","bundles/discussions/utils/unreadTracker","pages/open-course/common/models/currentSocialProfile","pages/open-course/common/promises/groupAuthorizationPromise","vendor/cnpm/fluxible.v0-4/addons/connectToStores","js/lib/connectToRouter","bundles/discussions/utils/routerConnectToCurrentForum","bundles/naptimejs/resources/onDemandCourseForums.v1","bundles/naptimejs/resources/onDemandMentorForums.v1","bundles/naptimejs/resources/groupForums.v1","bundles/discussions/components/discussionsForumsHOC","bundles/discussions/utils/areHighlightedPostsEnabled","i18n!nls/discussions","css!./__styles__/ThreadDetail"],function(require,exports,module){"use strict";function _defaults(e,n){for(var r=Object.getOwnPropertyNames(n),s=0;s<r.length;s++){var t=r[s],o=Object.getOwnPropertyDescriptor(n,t);o&&o.configurable&&void 0===e[t]&&Object.defineProperty(e,t,o)}return e}function _classCallCheck(e,s){if(!(e instanceof s))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(s,e){if(!s)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?s:e}function _inherits(s,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);s.prototype=Object.create(e&&e.prototype,{constructor:{value:s,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(s,e):_defaults(s,e))}var o,i,p=require("jsuri"),g=require("react-router"),S=g.Link,e=require("react"),_=require("underscore"),u=require("bundles/discussions/actions/ThreadDetailsActions"),E=u.fetchThread,s=u.fetchAnswers,l=require("bundles/discussions/components/discussionsBody/DetailedQuestion"),m=require("bundles/discussions/components/SessionDetails"),h=require("bundles/discussions/components/SoftDelete"),f=require("bundles/discussions/components/profiles/ProfileArea"),y=require("bundles/discussions/components/repliesList/HighlightedReply"),b=require("bundles/discussions/components/repliesList/RepliesList"),c=require("bundles/discussions/components/repliesList/ReplyCMLInput"),T=require("bundles/discussions/components/NextViewLink"),I=require("bundles/discussions/components/ModerationDropdown"),P=require("bundles/discussions/components/threadSettings/ThreadSettings"),t=require("bundles/discussions/constants"),a=t.savingStates,v=t.answerSorts,n=t.defaults,x=t.answers,d=t.naptimeForumTypes,w=require("bundles/discussions/utils/discussionsUrl"),q=w.buildUrl,D=require("bundles/discussions/api/threadDetailsUtils"),k=D.getAnswerPosition,R=require("bundles/discussions/utils/unreadTracker"),r=require("pages/open-course/common/models/currentSocialProfile"),C=require("pages/open-course/common/promises/groupAuthorizationPromise"),F=require("vendor/cnpm/fluxible.v0-4/addons/connectToStores"),N=require("js/lib/connectToRouter"),A=require("bundles/discussions/utils/routerConnectToCurrentForum"),j=require("bundles/naptimejs/resources/onDemandCourseForums.v1"),L=require("bundles/naptimejs/resources/onDemandMentorForums.v1"),M=require("bundles/naptimejs/resources/groupForums.v1"),O=require("bundles/discussions/components/discussionsForumsHOC"),U=require("bundles/discussions/utils/areHighlightedPostsEnabled"),z=require("i18n!nls/discussions"),H=x.limitPerPage;require("css!./__styles__/ThreadDetail");var B=(i=o=function(t){function ThreadDetail(){var o,s,n;_classCallCheck(this,ThreadDetail);for(var r=arguments.length,i=Array(r),e=0;r>e;e++)i[e]=arguments[e];return o=s=_possibleConstructorReturn(this,t.call.apply(t,[this].concat(i))),s.state={canTeach:!1,inputClickCounter:0},n=o,_possibleConstructorReturn(s,n)}return _inherits(ThreadDetail,t),ThreadDetail.prototype.componentWillMount=function componentWillMount(){var e=this.props,i=e.questionId,o=e.sort,r=e.page,a=e.answerId,u=e.userId,c=e.contextId,t=e.currentForum;this.context.executeAction(E,{questionId:i,userId:u,contextId:c,sort:o,page:r,forumType:t&&t.forumType.typeName}),a||1===r&&o===n.detailSort||this.context.executeAction(s,{questionId:i,userId:u,contextId:c,sort:o,page:r,forumType:t&&t.forumType.typeName,includeDeleted:this.props.hasModerationRole})},ThreadDetail.prototype.componentDidMount=function componentDidMount(){this.getRole(),this.fetchAnswerPosition(),this._isMounted=!0},ThreadDetail.prototype.componentWillReceiveProps=function componentWillReceiveProps(e){var o=e.questionId,n=e.userId,r=e.contextId,i=e.sort,u=e.page,t=e.currentForum;e.sort!==this.props.sort||e.page!==this.props.page?this.context.executeAction(s,{questionId:o,userId:n,contextId:r,sort:i,page:u,forumType:t&&t.forumType.typeName,includeDeleted:this.props.hasModerationRole}):this.props.answerSavingState===a.SAVING&&e.answerSavingState===a.SAVED&&(this.context.executeAction(s,{questionId:o,userId:n,contextId:r,sort:i,page:u,forumType:t&&t.forumType.typeName,includeDeleted:this.props.hasModerationRole}),this.context.router.push({pathname:window.location.pathname,params:{},query:{sort:v.newestSort}}))},ThreadDetail.prototype.componentDidUpdate=function componentDidUpdate(e,s,t){(e.questionId!==this.props.questionId||e.currentForum&&e.currentForum.id!==this.props.currentForum.id)&&this.markRead()},ThreadDetail.prototype.componentWillUnmount=function componentWillUnmount(){this._isMounted=!1},ThreadDetail.prototype.getRole=function getRole(){var s=this,e=this.props,n=e.authenticated,r=e.isSuperuser,t=e.currentForum,o=t&&t.forumType.definition.groupId;o?C(o,n,r).then(function(e){s._isMounted&&s.setState({canTeach:e})}):this.setState({canTeach:this.props.hasModerationRole})},ThreadDetail.prototype.getBackLinkDescription=function getBackLinkDescription(){return this.props.currentForum.title},ThreadDetail.prototype.fetchAnswerPosition=function fetchAnswerPosition(){var t=this,e=this.props,u=e.answerId,r=e.questionId,i=e.userId,c=e.contextId,o=e.currentForum,l=e.currentForumUrl,d=e.sort,a=e.page;if(!u)return;k(u,d,H).then(function(e){e===a?t.context.executeAction(s,{questionId:r,userId:i,contextId:c,sort:d,page:a,forumType:o&&o.forumType.typeName,includeDeleted:t.props.hasModerationRole}):t.context.router.replace({pathname:t.context.router.location.pathname,params:{},query:Object.assign(_.object(new p(t.context.router.location.search).queryPairs),{page:e})})}).fail(function(){var e=l;t.context.router.replace(q(e,r)),t.context.executeAction(s,{userId:i,contextId:c,questionId:r,sort:n.detailSort,page:n.detailPage,forumType:o&&o.forumType.typeName,includeDeleted:t.props.hasModerationRole})}).done()},ThreadDetail.prototype.markRead=function markRead(){R.markRead(this.props.questionId)},ThreadDetail.prototype.render=function render(){var i=this,t=this.props,s=t.question,a=t.isClosed,T=t.isPinned,D=t.currentForumUrl,o=t.currentForum,x=t.sort,q=t.page,u=t.questionId,p=t.answerId,g=t.commentId,w=t.courseId,n=D,I=o&&o.forumType.typeName,k=d.mentorForumType,R=d.groupForumType,v=o&&[k,R].indexOf(I)<0,C=v,E=this.state.canTeach&&s&&v;return e.createElement("div",{className:"rc-ThreadDetail"},E&&e.createElement(m,{isPinned:T,question:s}),e.createElement("div",{className:"discussion-content"},e.createElement("div",{className:"horizontal-box align-items-vertical-center align-items-spacebetween"},e.createElement(S,{to:this.props.backLink,className:"back-area nostyle"},e.createElement("div",{className:"horizontal-box align-items-vertical-center"},e.createElement("i",{className:"back-arrow cif-arrow-left c-back-arrow-image"}),e.createElement("h4",{className:"headline-2-text c-back-label"},this.getBackLinkDescription()))),this.state.canTeach&&s&&e.createElement(P,{question:s,shouldShowMoveThread:C})),e.createElement("div",{className:"frost-container"},e.createElement("div",null,e.createElement(l,{goToInput:function goToInput(){return i.setState({inputClickCounter:i.state.inputClickCounter+1})},question:s,isPinned:T,forumLink:n}),a&&e.createElement("div",{className:"c-thread-locked card-no-action color-secondary-text"},e.createElement("div",{className:"horizontal-box align-items-absolute-center"},e.createElement("i",{className:"cif-lock"}),z("This thread is closed. You cannot add any more responses.")))),e.createElement("div",null,U(w,I)&&e.createElement(y,{answerId:p,commentId:g,forumLink:n,questionId:u}),s&&e.createElement(b,{page:q,sort:x,answerId:p,commentId:g,forumLink:n,questionId:u}),!a&&e.createElement("div",{className:"reply-container horizontal-box"},e.createElement(f,{fullName:r.get("fullName"),externalUserId:r.get("externalUserId"),profileImageUrl:r.getProfileImageUrl()}),s&&e.createElement(c,{question:s,parentPost:s,savingState:this.props.answerSavingState,shouldFocusCounter:this.state.inputClickCounter})),s&&s.state&&s.state.deleted&&e.createElement(h,{entry:s,hideUndoDelete:!1})))))},ThreadDetail}(e.Component),o.propTypes={questionId:e.PropTypes.string.isRequired,sort:e.PropTypes.string.isRequired,page:e.PropTypes.number.isRequired,backLink:e.PropTypes.string.isRequired,authenticated:e.PropTypes.bool.isRequired,isSuperuser:e.PropTypes.bool.isRequired,answerSavingState:e.PropTypes.string,answerId:e.PropTypes.string,commentId:e.PropTypes.string,question:e.PropTypes.object,isClosed:e.PropTypes.bool,isPinned:e.PropTypes.bool,contextId:e.PropTypes.string,userId:e.PropTypes.number,courseId:e.PropTypes.string,currentForum:e.PropTypes.oneOfType([e.PropTypes.instanceOf(j),e.PropTypes.instanceOf(L),e.PropTypes.instanceOf(M)]),currentForumUrl:e.PropTypes.string,hasModerationRole:e.PropTypes.bool},o.contextTypes={executeAction:e.PropTypes.func.isRequired,router:e.PropTypes.object.isRequired},i);module.exports=_.compose(F(["ThreadDetailsStore","ThreadSettingsStore","CourseStore","ApplicationStore"],function(e,r){var o=e.ThreadDetailsStore,n=e.ThreadSettingsStore,u=e.CourseStore,s=e.ApplicationStore,i=r.questionId,t=o.getQuestion(i);return{question:t,answerSavingState:t&&o.savingStates[t.id],isClosed:n.isClosed(),isPinned:n.isPinned(),userId:s.getUserData().id,authenticated:s.isAuthenticatedUser(),isSuperuser:s.isSuperuser()}}),O({fields:["link","title"],subcomponents:[T,c,I]}),N(A))(B)});