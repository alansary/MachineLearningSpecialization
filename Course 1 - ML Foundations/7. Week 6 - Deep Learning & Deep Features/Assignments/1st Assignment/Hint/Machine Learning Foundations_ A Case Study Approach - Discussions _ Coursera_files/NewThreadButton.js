define("bundles/discussions/components/NewThreadButton",["require","exports","module","react","react-dom","underscore","js/lib/path","bundles/page/components/TrackedButton","bundles/phoenix/components/Modal","bundles/iconfont/Icon","bundles/discussions/components/NewThreadFormComponents","bundles/discussions/components/sessionFilter/SessionFilterDropdown","bundles/discussions/actions/ThreadsActions","pages/open-course/common/utils/ensureEnrolled","bundles/discussions/utils/discussionsUrl","bundles/cml/utils/CMLUtils","bundles/discussions/utils/DiscussionsCMLUtils","bundles/discussions/constants","bundles/naptimejs/resources/onDemandCourseForums.v1","bundles/naptimejs/resources/onDemandMentorForums.v1","bundles/naptimejs/resources/groupForums.v1","js/lib/waitFor","js/lib/mapProps","js/lib/connectToRouter","vendor/cnpm/fluxible.v0-4/addons/connectToStores","bundles/discussions/utils/routerConnectToCurrentForum","bundles/discussions/components/discussionsForumsHOC","js/lib/provideFluxibleAppContext","i18n!nls/discussions","css!bundles/discussions/components/__styles__/NewThreadButton"],function(require,exports,module){"use strict";function _defaults(e,o){for(var n=Object.getOwnPropertyNames(o),t=0;t<n.length;t++){var s=n[t],r=Object.getOwnPropertyDescriptor(o,s);r&&r.configurable&&void 0===e[s]&&Object.defineProperty(e,s,r)}return e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):_defaults(t,e))}var a,c,e=require("react"),o=require("react-dom"),_=require("underscore"),T=require("js/lib/path"),n=require("bundles/page/components/TrackedButton"),A=require("bundles/phoenix/components/Modal"),k=require("bundles/iconfont/Icon"),r=require("bundles/discussions/components/NewThreadFormComponents"),p=r.TitleInput,m=r.ContentInput,h=r.ForumSelector,f=require("bundles/discussions/components/sessionFilter/SessionFilterDropdown"),v=require("bundles/discussions/actions/ThreadsActions"),b=v.addThread,y=require("pages/open-course/common/utils/ensureEnrolled"),B=require("bundles/discussions/utils/discussionsUrl"),g=B.buildUrl,S=require("bundles/cml/utils/CMLUtils"),F=require("bundles/discussions/utils/DiscussionsCMLUtils"),i=require("bundles/discussions/constants"),E=i.DTD_NAME,s=i.savingStates,l=i.naptimeForumTypes,w=require("bundles/naptimejs/resources/onDemandCourseForums.v1"),C=require("bundles/naptimejs/resources/onDemandMentorForums.v1"),N=require("bundles/naptimejs/resources/groupForums.v1"),I=require("js/lib/waitFor"),x=require("js/lib/mapProps"),M=require("js/lib/connectToRouter"),P=require("vendor/cnpm/fluxible.v0-4/addons/connectToStores"),j=require("bundles/discussions/utils/routerConnectToCurrentForum"),O=require("bundles/discussions/components/discussionsForumsHOC"),D=require("js/lib/provideFluxibleAppContext"),t=require("i18n!nls/discussions");require("css!bundles/discussions/components/__styles__/NewThreadButton");var d=(c=a=function(r){function NewThreadButton(t,s){_classCallCheck(this,NewThreadButton);var e=_possibleConstructorReturn(this,r.call(this,t,s));return e.handleSubmit=function(){var r=_(e.state).any(function(e){return e.hasError});if(r)e.state.title.hasError?o.findDOMNode(e.refs.title).focus():e.state.content.hasError?o.findDOMNode(e.refs.content.refs.content.refs.editorWrapper.refs.editor).focus():e.state.currentForum.hasError&&o.findDOMNode(e.refs.currentForum).focus(),e.setState({showErrors:!0});else{var t={title:e.state.title.value,content:e.state.content.value};e.props.showSessionSelector?t.context=e.state.activeFilterId:e.props.filter&&(t.context=e.props.filter.id);var s=e.state.currentForum,n=!!t.context&&"all"!==t.context&&"ondemand"!==t.context,a={content:{question:t.title,details:t.content},overrideSessionId:n?t.context:void 0,state:{},userId:e.props.userId,courseForumId:s.value.id,mentorForumId:s.value.id,groupForumId:s.value.id},i=s.value.forumId,l=s.value.forumType&&s.value.forumType.typeName;e.setState({saving:!0}),e.context.executeAction(b,{options:a,forumType:l,forumId:i})}},e.handleDropdownChange=function(t){e.setState({activeFilterId:t})},e.handleOpenModal=function(){var t=e.props,s=t.userId,r=t.course,o=t.verificationDisplay;y(s,r,o).then(function(){return e.handleOpen()})},e.handleCloseModal=function(t){"x"===t?e.setState(e.resetState()):e.setState({showModal:!1})},e.handleCloseModalByX=e.handleCloseModal.bind(e,"x"),e.handleInputChange=function(t,s){e.state[t].value=s.value,e.state[t].hasError=!s.isValid,e.setState(e.state)},e.state=e.resetState(),e}return _inherits(NewThreadButton,r),NewThreadButton.prototype.componentWillReceiveProps=function componentWillReceiveProps(e){if(!this.state.saving){var t=this.props.currentForum,r=!t;this.setState({currentForum:{value:t,hasError:r}})}this.props.threadSavingState===s.SAVING&&e.threadSavingState===s.SAVED?this.handleSaveSuccess(e.newThread):this.props.threadSavingState===s.SAVING&&e.threadSavingState===s.ERROR&&this.handleSaveError()},NewThreadButton.prototype.handleSaveSuccess=function handleSaveSuccess(e){var t=T.join(this.props.rootPath,this.state.currentForum.value.link);this.context.router.push(g(t,e.questionId)),this.setState(this.resetState())},NewThreadButton.prototype.handleSaveError=function handleSaveError(){this.setState({saveError:!0,saveErrorMessage:t("Something went wrong. Please reload the page and try again."),saving:!1})},NewThreadButton.prototype.handleOpen=function handleOpen(){this.setState({showModal:!this.state.showModal})},NewThreadButton.prototype.resetState=function resetState(){var e=this.props.currentForum,t=!e;return{showModal:!1,title:{value:"",hasError:!0},content:{value:S.create("",E),hasError:!0},currentForum:{value:e,hasError:t},showErrors:!1,saving:!1,saveError:!1,saveErrorMessage:""}},NewThreadButton.prototype.render=function render(){var s=this,i=F.generateContentLengthWarning(this.state.content.value),l=e.createElement("div",{className:"error-text c-modal-error-message"},this.state.saveErrorMessage),r=null,u=this.state.currentForum.value,c=this.props.forums.filter(function(e){return!e.parentForumId||e.parentForumId===s.props.rootForumId}),o=_(c.map(function(e){return[e].concat(s.props.forums.filter(function(t){return t.parentForumId===e.id}))})).flatten();o.length&&(r=e.createElement("div",{className:"c-input-area"},e.createElement("label",{className:"c-form-label-area",htmlFor:"forum-selector"},e.createElement("h2",{className:"c-form-label headline-1-text"},t("Forum"))),e.createElement(h,{ref:"currentForum",id:"forum-selector",rootForumId:this.props.rootForumId,hasError:this.state.showErrors&&this.state.currentForum.hasError,handleInputChange:this.handleInputChange,forums:o,value:u})));var a=void 0;this.props.showSessionSelector&&(a=e.createElement("div",{className:"context-selector-container"},e.createElement("div",{className:"bgcolor-divider bt3-pull-left section-divider"}),e.createElement("div",{className:"c-input-area"},e.createElement("h3",{className:"headline-1-text"},t("You're currently viewing All Sessions.")),e.createElement("label",{htmlFor:"new-thread-sessions-switcher"},e.createElement("span",{className:"caption-text color-secondary-text"},t("Which session should this thread go in?"))),e.createElement(f,{id:"new-thread-sessions-switcher",hideAllSessionsOption:!0,limitSwitchingToCurrentBranch:!0,dropup:!0,handleDropdownChange:this.handleDropdownChange}))));var d=e.createElement(A,{handleClose:this.handleCloseModal,modalName:t("Create a new thread"),className:"new-thread-modal"},e.createElement("h1",{className:"c-modal-title headline-3-text"},t("Create a new thread")),e.createElement("div",{className:"c-input-area"},e.createElement("label",{className:"c-form-label-area",htmlFor:"title-input"},e.createElement("h2",{className:"c-form-label headline-1-text"},t("Title"))),e.createElement(p,{id:"title-input",ref:"title",hasError:this.state.showErrors&&this.state.title.hasError,value:this.state.title.value,handleInputChange:this.handleInputChange})),e.createElement("div",{className:"c-input-area"},e.createElement("label",{className:"c-form-label-area",htmlFor:"content-input"},e.createElement("h2",{className:"c-form-label headline-1-text"},t("Body"))),e.createElement(m,{id:"content-input",ref:"content",courseId:this.props.courseId,hasError:this.state.showErrors&&this.state.content.hasError,handleInputChange:this.handleInputChange,cml:this.state.content.value})),r,a,e.createElement("div",null,i,this.state.saveError&&l,e.createElement("div",{className:"horizontal-box align-items-right"},e.createElement("button",{className:"passive",onClick:this.handleCloseModalByX},t("Cancel")),"  ",e.createElement(n,{ref:"submit",disabled:this.state.saving,className:"secondary",type:"submit",onClick:this.handleSubmit,trackingName:"new_thread_create"},t("Post")))));return e.createElement("div",{className:"rc-NewThreadForm shrink-block horizontal-box align-items-right"},e.createElement(n,{ref:"newThreadButton",className:"c-new-thread-button secondary large-screen",onClick:this.handleOpenModal,trackingName:"new_thread_button"},t("New Thread")),e.createElement(n,{ref:"newThreadButton",className:"nostyle align-right mobile hide",onClick:this.handleOpenModal,trackingName:"new_thread_button"},e.createElement(k,{name:"plus"})),this.state.showModal&&d)},NewThreadButton}(e.Component),a.propTypes={userId:e.PropTypes.number,rootForumId:e.PropTypes.string,forums:e.PropTypes.arrayOf(e.PropTypes.object),currentForumId:e.PropTypes.string,currentForum:e.PropTypes.oneOfType([e.PropTypes.instanceOf(w),e.PropTypes.instanceOf(C),e.PropTypes.instanceOf(N)]),showSessionSelector:e.PropTypes.bool,rootPath:e.PropTypes.string,filter:e.PropTypes.shape({id:e.PropTypes.string}),threadSavingState:e.PropTypes.string,courseId:e.PropTypes.string,course:e.PropTypes.object,verificationDisplay:e.PropTypes.object},a.contextTypes={executeAction:e.PropTypes.func.isRequired,router:e.PropTypes.object.isRequired},c),u=_.compose(P(["SessionFilterStore","ThreadsStore","ApplicationStore","CourseMembershipStore","VerificationStore","CourseStore"],function(e,i){var t=e.SessionFilterStore,s=e.ThreadsStore,r=e.ApplicationStore,n=e.CourseMembershipStore,a=e.VerificationStore,o=e.CourseStore;return{showSessionSelector:(r.isSuperuser()||n.hasModerationRole())&&"all"===t.activeFilterQueryString,filter:t.activeFilter,threadSavingState:s.savingState,newThread:s.threadToInsert,userId:r.getUserData().id,verificationDisplay:a.getVerificationDisplay(),course:o.getMetadata(),courseId:o.getCourseId()}}),O({fields:["forumType","title","link"]}),M(j),x(function(e){var t=e.currentForum&&e.currentForum.forumType.typeName!==l.rootForumType&&e.currentForum||void 0,s=e.courseForums&&e.courseForums.find(function(e){return e.forumType.typeName===l.rootForumType});return{forums:e.courseForums?e.courseForums.filter(function(e){return e.forumType.typeName!==l.rootForumType}).concat(e.mentorForums).concat(e.groupForums):[],rootForumId:s&&s.id,currentForum:t,currentForumId:t&&t.id}}),I(function(e){return e.forums.length}))(d);module.exports=D()(u),module.exports.NewThreadButtonNaptimeContainer=u,module.exports.BaseComp=d});